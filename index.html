<html>

<head>
    <meta charset="utf-8">
    <title>AirNavi</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #menu {
            position: absolute;
            background: #efefef;
            padding: 10px;
            font-family: 'Open Sans', sans-serif;
            bottom: 25px;
        }
    </style>
</head>

<body>
    <style>
        /* Body for the slider and legend */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, Arial, Sans-serif;
        }

        #menu {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            position: absolute;
            z-index: 1;
            right: 10px;
            border-radius: 3px;
            width: 120px;
            border: 1px solid rgba(0, 0, 0, 0.4);
            font-family: 'Open Sans', sans-serif;
        }

        #menu a {
            font-size: 13px;
            color: #404040;
            display: block;
            margin: 0;
            padding: 0;
            padding: 10px;
            text-decoration: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.25);
            text-align: center;
        }

        #menu a:last-child {
            border: none;
        }

        #menu a:hover {
            background-color: #f8f8f8;
            color: #404040;
        }

        #menu a.active {
            background-color: #3887be;
            color: #ffffff;
        }

        #menu a.active:hover {
            background: #3074a4;
        }

        h1 {
            font-size: 20px;
            line-height: 30px;
        }

        h2 {
            font-size: 14px;
            line-height: 20px;
            margin-bottom: 10px;
        }

        a {
            text-decoration: none;
            color: #2DC4B2;
        }

        #consoleText {
            position: fixed;
            width: 240px;
            margin: 10px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            bottom: 10px;
        }

        .session {
            margin-bottom: 20px;
        }

        .row {
            height: 12px;
            width: 100%;
        }

        /* Legend gradient colors */
        .colors {
            background: linear-gradient(to right,
                    #00ffbf,
                    #00E700,
                    #FFEE00,
                    #FFC400,
                    #FF3C00,
                    #A00000);
            margin-bottom: 5px;
        }

        .label {
            width: 15%;
            display: inline-block;
            text-align: center;
        }

        /* Legend box colors */
        .box {
            float: left;
            width: 15px;
            height: 15px;
            border: 1px solid rgba(0, 0, 0, .2);
        }

        .excellent {
            background: #07cf00
        }

        .good {
            background: #84ff00
        }

        .moderate {
            background: #ffdd00
        }

        .low {
            background: #ff6200
        }

        .poor {
            background: #bd0000
        }

        /* Legend for SLB */
        .slb {
            height: 12px;
            width: 100%;
            background: linear-gradient(to right,
                    #00ffbf,
                    #00E700,
                    #FFEE00,
                    #FFC400,
                    #FF3C00,
                    #A00000);
            margin-bottom: 5px;
        }
    </style>

    <nav id="menu"></nav>
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css"
        type="text/css">
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
        type="text/css">
    <div id="map"></div>

    <div id="consoleText">
        <h1>Air Quality Data</h1>
        <p>
            Data: <br>
            <a href="https://www.slb.nu/slbanalys/luftfororeningskartor/">PM10,</a>
            <a href="https://docs.breezometer.com/api-documentation/heatmap-tile-overlay/v1/#overview">
                AQI, PM2.5 and traffic pollution
            </a>
            values in Stockholm, year 2021
        </p>
        <div class="session">
            <div>
                <h2 style="display:inline" id="active-layer-label">AQI</h2>
                <div style="display:none" id="unit"> &microg/m<sup>3</sup></div>
            </div>

            <div id="gradientBar" class="row colors" style="display:block"></div>
            <div id="gradientLegend" class="row labels" style="display:none">
                <div class="label">0</div>
                <div class="label">5</div>
                <div class="label">10</div>
                <div class="label">15</div>
                <div class="label">20</div>
                <div class="label">25+</div>
            </div>

            <div id="AQIlegend">
                <div class="box excellent"></div> &nbspExcellent <br>
                <div class="box good"></div> &nbspGood <br>
                <div class="box moderate"></div> &nbspModerate <br>
                <div class="box low"></div> &nbspLow <br>
                <div class="box poor"></div> &nbspPoor <br>
            </div>

            <img id="slblegend" src="https://raw.githubusercontent.com/neon-code/AirNavi/main/slblegend.png"/>

            <div id="trafficInfo" style="display:none">Highlighted roads suffer from high traffic</div>
        </div>

        <div class='session' id='sliderbar'>
            <h2>Date: <label id='active-date'>08/03/2021</label></h2>
            <input id='slider' class='row' type='range' min=0 max=55 step=1 value=55 />
        </div>

        <div class="session" id='polutant'>
            <h2>Pollutant type</h2>
            <div class="row" id="filters">
                <input id="pm10button" type="radio" name="toggle" value="pm10button" checked="checked" />
                <label for="pm10button">PM10</label>

                <input id="pm25button" type="radio" name="toggle" value="pm25button" />
                <label for="pm25button">PM2.5</label>
            </div>
        </div>

    </div>

    <script>
        var apiKey = '93207702882a463c9fc8e53777fcf006'; // Your BreezoMeter API key
        mapboxgl.accessToken = 'pk.eyJ1Ijoic3lhbDEyMyIsImEiOiJja2xxZmp2ejMxY2xlMm5uM2EwbzN4N2RiIn0.fbgkVbfRijgPYmlPWYtPqg';
        //set bounds
        var bounds = [
            [17.87084, 59.24744],
            [18.27879, 59.40520]
        ];
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/streets-v11', // style URL
            center: [18.07030, 59.32495], // starting position [lng, lat]
            zoom: 12,    // starting zoom
            maxBounds: bounds,
            minZoom: 11,
            maxZoom: 15
        });

        map.addControl(
            new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl
            })
        );
        // map.addControl(new mapboxgl.NavigationControl());
        map.addControl(
            new MapboxDirections({
                accessToken: mapboxgl.accessToken
            }),
            'top-left'
        );

        //Initialize locations from files
        function fetchJSON(url) {
            return fetch(url)
                .then(function (response) {
                    return response.json();
                });
        }
        var mapData;
        var uniqueDateTime = new Set();
        var dateTimeArray = [];
        var pm10filterDate = ['==', ['string', ['get', 'date']], '00/00/00'];

        map.on("load", function () {
            addRasterSource();
            addRasterLayer();
            addRoadsSource();
            addRoadsLayer();
            addpm25Raster();
            addPm25Layer();

            addpm10Raster();
            addPm10Layer();
            addAqiSlbRaster();
            addAqiSlbLayer();

            //Fetching file for heatmap data
            map.addSource('sthlm', {
                type: 'geojson',
                data: 'https://raw.githubusercontent.com/neon-code/OSMtest/main/sthlm.geojson'
            });

            //Fetching file for dates
            var mapDataPromise = fetchJSON('https://raw.githubusercontent.com/neon-code/OSMtest/main/sthlm.geojson')
                .then(function (data) {
                    mapData = data;
                    data.features.forEach(function (feature) {
                        uniqueDateTime.add(feature.properties.date);
                    });
                    dateTimeArray = [...uniqueDateTime];
                    pm10filterDate = ['==', ['string', ['get', 'date']], dateTimeArray[0]];
                    //Add PM history layers
                    addHistoricalPm10Layer();
                    addHistoricalPm25Layer();

                    // update Date filter when the slider is dragged
                    document
                        .getElementById('slider')
                        .addEventListener('input', function (e) {
                            selecteddate = parseInt(e.target.value);
                            // update the map
                            pm10filterdate = ['==', ['string', ['get', 'date']], dateTimeArray[dateTimeArray.length - 1 - selecteddate]];
                            map.setFilter('pm10Historical', ['all', pm10filterdate]);
                            map.setFilter('pm25Historical', ['all', pm10filterdate]);
                            //Update slider date
                            document.getElementById('active-date').innerText = dateTimeArray[dateTimeArray.length - 1 - selecteddate];
                        });

                    //Update when pollutant type is selected
                    document.getElementById('filters').addEventListener('change', function(e) {
                        var filterpollutant = e.target.value;

                        if (filterpollutant === 'pm10button') {
                            map.setLayoutProperty('pm10Historical', 'visibility', 'visible');
                            map.setLayoutProperty('pm25Historical', 'visibility', 'none');
                        } else {
                            map.setLayoutProperty('pm10Historical', 'visibility', 'none');
                            map.setLayoutProperty('pm25Historical', 'visibility', 'visible');
                        }
                    });

                });
        });

        //Breezometer AQI
        function addRasterSource() {
            map.addSource("breezometer-tiles", {
                type: "raster",
                tiles: [
                    `https://tiles.breezometer.com/v1/air-quality/breezometer-aqi/current-conditions/{z}/{x}/{y}.png?key=${apiKey}`//
                ],
                tileSize: 256,
                maxzoom: 8
            });
        }
        function addRasterLayer() {
            map.addLayer(
                {
                    id: "aqi",
                    type: "raster",
                    source: "breezometer-tiles",
                    minzoom: 0,
                    maxzoom: 22,
                    'layout': {
                        // make layer visible by default
                        'visibility': 'visible'
                    },
                    paint: {
                        "raster-opacity": 0.5
                    }
                },
                "admin-1-boundary-bg"
            );
        }

        //SLB PM10
        function addpm10Raster() {
            map.addSource('wmsPM10Source', {
                'type': 'raster',
                // use the tiles option to specify a WMS tile source URL
                // https://docs.mapbox.com/mapbox-gl-js/style-spec/sources/
                'tiles': [
                    'https://gis.slbanalys.se/geoserver/slb/wms?service=WMS&request=GetMap&layers=pm10_d01&styles=&format=image%2Fpng&transparent=true&version=1.3.0&width=1024&height=1024&crs=EPSG%3A3857&bbox={bbox-epsg-3857}'
                ],
                'tileSize': 512
            });
        }
        function addPm10Layer() {
            map.addLayer(
                {
                    'id': 'slb-pm10',
                    'type': 'raster',
                    'source': 'wmsPM10Source',

                    layout: {
                        "visibility": "none"
                    },
                    paint: {
                        "raster-opacity": 0.6
                    }

                }
                //'aeroway-line'
            );
        }

        //SLB AQI
        function addAqiSlbRaster() {
            map.addSource('aqiSlbSource', {
                'type': 'raster',
                // use the tiles option to specify a WMS tile source URL
                // https://docs.mapbox.com/mapbox-gl-js/style-spec/sources/
                'tiles': [
                    'https://gis.slbanalys.se/geoserver/slb/wms?service=WMS&request=GetMap&layers=aqhi_d01&styles=&format=image%2Fpng&transparent=true&version=1.3.0&width=256&height=256&crs=EPSG%3A3857&bbox={bbox-epsg-3857}'
                ],
                'tileSize': 256
            });
        }
        function addAqiSlbLayer() {
            map.addLayer(
                {
                    'id': 'slb-aqi',
                    'type': 'raster',
                    'source': 'aqiSlbSource',

                    layout: {
                        "visibility": "none"
                    },
                    paint: {
                        "raster-opacity": 0.6
                    }

                }
                //'aeroway-line'
            );
        }

        //Breezometer Roads
        function addRoadsSource() {
            map.addSource("roads", {
                type: "vector",
                tiles: [
                    `https://tiles.breezometer.com/v1/air-quality/traffic-pollution/current-conditions/{z}/{x}/{y}.pbf?key=${apiKey}`
                ],
                minzoom: 0,
                maxzoom: 10
            });
        }
        function addRoadsLayer() {
            map.addLayer(
                {
                    id: "traffic",
                    source: "roads",
                    "source-layer": "brz-roads",
                    type: "line",
                    layout: {
                        "line-cap": "round",
                        "visibility": "none"
                    },
                    minzoom: 3,
                    maxzoom: 24
                },
                "admin-1-boundary-bg"
            );
        }

        //Breezometer PM25
        function addpm25Raster() {
            map.addSource("breezometer-tiles-pm25", {
                type: "raster",
                tiles: [`https://tiles.breezometer.com/v1/air-quality/pm25/current-conditions/{z}/{x}/{y}.png?key=${apiKey}`],
                tileSize: 256,
                maxzoom: 8
            });
        }
        function addPm25Layer() {
            map.addLayer(
                {
                    id: "pm2.5",
                    type: "raster",
                    source: "breezometer-tiles-pm25",
                    minzoom: 0,
                    maxzoom: 22,
                    layout: {
                        "visibility": "none"
                    },
                    paint: {
                        "raster-opacity": 0.5
                    }
                },
                "admin-1-boundary-bg"
            );
        }

        //History PM10
        function addHistoricalPm10Layer() {
            //Heatmap
            map.addLayer({
                id: 'pm10Historical',
                type: 'heatmap',
                source: 'sthlm',
                maxzoom: 20,
                layout: {
                    "visibility": "none"
                },
                paint: {
                    // increase weight as diameter breast height increases
                    'heatmap-weight': {
                        property: 'pm10',
                        type: 'exponential',
                        stops: [
                            [1, 0],
                            [80, 1]
                        ]
                    },
                    // increase intensity as zoom level increases
                    'heatmap-intensity': {
                        stops: [
                            [5, 1],
                            [18, 2.5]
                        ]
                    },
                    // assign color values be applied to points depending on their density
                    'heatmap-color': [
                        'interpolate',
                        ['linear'],
                        ['heatmap-density'],
                        0.0, 'rgba(0,222,239,0)',
                        0.05, '#00ffbf',
                        0.2, '#00E700',
                        0.3, '#FFEE00',
                        0.4, '#FFC400',
                        0.5, '#FF3C00',
                        0.6, '#A00000'
                    ],
                    // increase radius as zoom increases
                    'heatmap-radius': {
                        stops: [
                            [7, 3],
                            [18, 200]
                        ]
                    },
                    // decrease opacity to transition into the circle layer
                    'heatmap-opacity': {
                        default: 0.5,
                        stops: [
                            [14, 0.5],
                            [20, 0.3]
                        ]
                    },
                }
            });
        }

        //History PM2.5
        function addHistoricalPm25Layer() {
            //Heatmap
            map.addLayer({
                id: 'pm25Historical',
                type: 'heatmap',
                source: 'sthlm',
                maxzoom: 20,
                layout: {
                    "visibility": "none"
                },
                paint: {
                    // increase weight as diameter breast height increases
                    'heatmap-weight': {
                        property: 'pm25',
                        type: 'exponential',
                        stops: [
                            [1, 0],
                            [80, 1]
                        ]
                    },
                    // increase intensity as zoom level increases
                    'heatmap-intensity': {
                        stops: [
                            [5, 1],
                            [18, 2.5]
                        ]
                    },
                    // assign color values be applied to points depending on their density
                    'heatmap-color': [
                        'interpolate',
                        ['linear'],
                        ['heatmap-density'],
                        0.0, 'rgba(0,222,239,0)',
                        0.09, '#00E700',
                        0.17, '#FFEE00',
                        0.20, '#ffbb00',
                        0.25, '#FF3C00',
                        0.3, '#A00000'
                    ],
                    // increase radius as zoom increases
                    'heatmap-radius': {
                        stops: [
                            [7, 3],
                            [18, 200]
                        ]
                    },
                    // decrease opacity to transition into the circle layer
                    'heatmap-opacity': {
                        default: 0.5,
                        stops: [
                            [14, 0.5],
                            [20, 0.3]
                        ]
                    },
                }
            });
        }


        //Setting sliderbar, radios and legends to visibility 0
        var barvisibility = document.getElementById("sliderbar");
        barvisibility.style.display = "none";
        document.getElementById("polutant").style.display = "none";
        var selecteddate = 55;
        document.getElementById("slblegend").style.display = "none";

        // enumerate ids of the toggleable layers
        var toggleableLayerIds = ['aqi', 'pm2.5', 'slb-aqi', 'slb-pm10', 'traffic'];
        // set up the corresponding toggle button for each layer
        for (var i = 0; i < toggleableLayerIds.length; i++) {
            var id = toggleableLayerIds[i];

            //HTML trash
            var link = document.createElement('a');
            link.href = '#';
            link.className = '';
            link.textContent = id.toUpperCase();
            //Setting AQI layer as active
            if (id == 'aqi') {
                link.className = 'active'
            }
            link.title = id;

            //Do something when layer is clicked
            link.onclick = function (e) {
                var clickedLayer = this.title;
                e.preventDefault();
                e.stopPropagation();

                var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

                // toggle layer visibility by changing the layout object's visibility property
                if (visibility === 'visible') {
                    map.setLayoutProperty(clickedLayer, 'visibility', 'none');
                    this.className = '';
                } else {
                    //Disable all other layers
                    for (var i = 0; i < toggleableLayerIds.length; i++) {
                        var id = toggleableLayerIds[i];
                        map.setLayoutProperty(id, 'visibility', 'none');
                        document.getElementsByTagName('a')[i].className = '';
                    }
                    //Disable the history layer as well
                    map.setLayoutProperty('pm10Historical', 'visibility', 'none');
                    map.setLayoutProperty('pm25Historical', 'visibility', 'none');
                    document.getElementsByTagName('a')[i].className = '';

                    //Disable slider
                    var barvisibility = document.getElementById("sliderbar");
                    barvisibility.style.display = "none";
                    document.getElementById("polutant").style.display = "none";

                    //setting this layer active   
                    this.className = 'active';
                    map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
                    document.getElementById('active-layer-label').innerText = this.title.toUpperCase();

                    // Display or disable unit and legend
                    if (this.title.toUpperCase().localeCompare("AQI") == 0 ||
                        this.title.toUpperCase().localeCompare("PM2.5") == 0) {
                        //Hide gradient bar
                        document.getElementById("gradientBar").style.display = "block";
                        if (this.title.toUpperCase().localeCompare("AQI") == 0) {
                        //Hide values under gradient
                        document.getElementById("gradientLegend").style.display = "none";
                        //Hide unit
                        document.getElementById("unit").style.display = "none";
                        } else {
                            document.getElementById("gradientLegend").style.display = "inline";
                            document.getElementById("unit").style.display = "inline";
                        }
                        // Display color coding for AQI
                        document.getElementById("AQIlegend").style.display = "inline";
                        //Hide traffic information
                        document.getElementById("trafficInfo").style.display = "none";
                        //Hide SLB legend
                        document.getElementById("slblegend").style.display = "none";
                    }
                    else if (this.title.toUpperCase().localeCompare("SLB-AQI") == 0 ||
                            this.title.toUpperCase().localeCompare("SLB-PM10") == 0) {
                        //Hide unit
                        document.getElementById("unit").style.display = "none";
                        if(this.title.toUpperCase().localeCompare("SLB-PM10") == 0){
                            document.getElementById("unit").style.display = "inline";  
                        }
                        //Hide gradient bar
                        document.getElementById("gradientBar").style.display = "none";
                        //Hide values under gradient
                        document.getElementById("gradientLegend").style.display = "none";
                        //Hide color coding for AQI
                        document.getElementById("AQIlegend").style.display = "none";
                        //Hide traffic information
                        document.getElementById("trafficInfo").style.display = "none";
                        //Show SLB legend
                        document.getElementById("slblegend").style.display = "inline";
                    }
                    else if (this.title.toUpperCase().localeCompare("TRAFFIC") == 0) {
                        document.getElementById("unit").style.display = "none";
                        document.getElementById("gradientLegend").style.display = "none";
                        document.getElementById("gradientBar").style.display = "none";
                        document.getElementById("AQIlegend").style.display = "none";
                        document.getElementById("slblegend").style.display = "none";
                        document.getElementById("trafficInfo").style.display = "inline";
                    }
                    else {
                        document.getElementById("unit").style.display = "inline";
                        document.getElementById("AQIlegend").style.display = "none";
                        document.getElementById("gradientLegend").style.display = "inline";
                        document.getElementById("gradientBar").style.display = "block";
                        document.getElementById("trafficInfo").style.display = "none";
                    }
                }
            };

            var layers = document.getElementById('menu');
            layers.appendChild(link);
        }

        //View History tab
        var link = document.createElement('a');
        link.href = '#';
        link.className = '';
        link.textContent = 'VIEW HISTORY';
        link.title = 'viewHistory';

        link.onclick = function (e) {
            var clickedLayer = 'pm10Historical'
            document.getElementById("pm10button").checked = true;
            e.preventDefault();
            e.stopPropagation();

            //Get status of history layer visibility
            var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

            // toggle history visibility by changing the layout object's visibility property
            if (visibility === 'visible') {
                map.setLayoutProperty(clickedLayer, 'visibility', 'none');
                this.className = '';

                //Disable slider
                var barvisibility = document.getElementById("sliderbar");
                barvisibility.style.display = "none";
                document.getElementById("polutant").style.display = "none";

            } else {
                //Disable all other layers
                for (var i = 0; i < toggleableLayerIds.length; i++) {
                    var id = toggleableLayerIds[i];
                    map.setLayoutProperty(id, 'visibility', 'none');
                    document.getElementsByTagName('a')[i].className = '';
                }

                //setting this layer active
                this.className = 'active';
                map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
                document.getElementById('active-layer-label').innerText = 'PM10';

                //Display slider
                var barvisibility = document.getElementById("sliderbar");
                barvisibility.style.display = "block";
                document.getElementById("polutant").style.display = "block";

                //Hide unit
                document.getElementById("unit").style.display = "inline";
                //Hide gradient bar
                document.getElementById("gradientBar").style.display = "none";
                //Hide values under gradient
                document.getElementById("gradientLegend").style.display = "none";
                //Hide color coding for AQI
                document.getElementById("AQIlegend").style.display = "none";
                //Hide traffic information
                document.getElementById("trafficInfo").style.display = "none";
                //Show SLB legend
                document.getElementById("slblegend").style.display = "inline";

            }

            //set map
            map.setFilter('pm25Historical', ['==', ['string', ['get', 'date']], dateTimeArray[dateTimeArray.length - 1 - selecteddate]]);
            map.setFilter('pm10Historical', ['==', ['string', ['get', 'date']], dateTimeArray[dateTimeArray.length - 1 - selecteddate]]);
        };

        var layers = document.getElementById('menu');
        layers.appendChild(link);

    </script>
</body>

</html>