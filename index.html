<html>
    <head>
        <meta charset='utf-8' />
        <title>AirNavi</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />

        <div id='map'></div>
        <div id='console'>
        </div>

        <style>
            body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, Arial, Sans-serif;
            }

            #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            }

            h1 {
            font-size: 20px;
            line-height: 30px;
            }

            h2 {
            font-size: 14px;
            line-height: 20px;
            margin-bottom: 10px;
            }

            a {
            text-decoration: none;
            color: #2dc4b2;
            }

            #console {
            position: absolute;
            width: 240px;
            margin: 10px;
            padding: 10px 20px;
            background-color: white;
            }

            .session {
                margin-bottom: 20px;
            }

            .row {
                height: 12px;
                width: 100%;
            }

            .colors {
                background: linear-gradient(
                to right,
                #00ffbf,
                #00e700,
                #ffee00,
                #ffc400,
                #ff3c00,
                #a00000
                );
                margin-bottom: 5px;
            }

            .label {
                width: 15%;
                display: inline-block;
                text-align: center;
            }
        </style>
    </head>

    <body>
        <div id="map"></div>
        <div id="console">
          <h1>Air Quality Data</h1>
          <p>
            Data:
            <a
              href="https://data.cityofnewyork.us/Public-Safety/NYPD-Motor-Vehicle-Collisions/h9gi-nx95"
              >PM10 values of air quality</a
            >
            in Stockholm, March 2021
          </p>
          <div class="session">
            <h2>PM10</h2>
            <div class="row colors"></div>
            <div class="row labels">
              <div class="label">0</div>
              <div class="label">25</div>
              <div class="label">50</div>
              <div class="label">75</div>
              <div class="label">100</div>
              <div class="label">175+</div>
            </div>

            <h2>PM25</h2>
            <div class="row colors"></div>
            <div class="row labels">
              <div class="label">0</div>
              <div class="label">15</div>
              <div class="label">30</div>
              <div class="label">45</div>
              <div class="label">60</div>
              <div class="label">110+</div>
            </div>

            <h2>NO2</h2>
            <div class="row colors"></div>
            <div class="row labels">
              <div class="label">0</div>
              <div class="label">50</div>
              <div class="label">100</div>
              <div class="label">200</div>
              <div class="label">300</div>
              <div class="label">400+</div>
            </div>
          </div>

          <div class='session' id='sliderbar'>
            <h2>Date: <label id='active-date'>08/03/2021</label></h2>
            <input id='slider' class='row' type='range' min=0 max=55 step=1 value=55 />
          </div>
          
          </div>
    </body>

    <script>
        function fetchJSON(url) {
            return fetch(url)
                .then(function(response) {
                return response.json();
                });
            }
        var mapData;
        var uniqueDateTime = new Set();
        var dateTimeArray = [];
        var arrLength;

        mapboxgl.accessToken = 'pk.eyJ1Ijoic3lhbDEyMyIsImEiOiJja2xxZmp2ejMxY2xlMm5uM2EwbzN4N2RiIn0.fbgkVbfRijgPYmlPWYtPqg';
        var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/light-v10',
          center: [18.07030,59.32495],
          zoom: 12
        });

        map.on('load', function() {
            var mapDataPromise = fetchJSON('https://raw.githubusercontent.com/neon-code/OSMtest/main/sthlm.geojson')
            .then(function(data) {
                mapData = data;
                data.features.forEach(function(feature) {
                uniqueDateTime.add(feature.properties.date);
            });
                dateTimeArray = [...uniqueDateTime];
                arrLength = dateTimeArray.length;
        
        //Initialize filter
        var filterDate = ['==', ['string', ['get', 'date']], dateTimeArray[0]];

        //PM10 layer
        map.addLayer({
            id: 'pm10',
            type: 'circle',
            source: {
            type: 'geojson',
            data: 'https://raw.githubusercontent.com/neon-code/OSMtest/main/sthlm.geojson' // replace this with the url of your own geojson
            },
            paint: {
            'circle-radius': [
                'interpolate',
                ['linear'],
                ['number', ['get', 'pm10']],
                0,  //Floor value of the scale
                34,  //Radius of floor value
                12,  //Ceiling value of the scale
                24  //Radius of Cieling Value
            ],
            'circle-color': [
                'interpolate',
                ['linear'],
                ['number', ['get', 'pm10']],
                0, '#00ff95',
                25, '#00c500',
                50, '#dbdf00',
                75, '#ffa600',
                100, '#ff3c00',
                175, '#a00000'
            ],
            'circle-opacity': 0.2
            },
            'filter': ['all', filterDate]
        });

        //PM25 layer
        map.addLayer({
            id: 'pm25',
            type: 'circle',
            source: {
            type: 'geojson',
            data: 'https://raw.githubusercontent.com/neon-code/OSMtest/main/sthlm.geojson' // replace this with the url of your own geojson
            },
            paint: {
            'circle-radius': [
                'interpolate',
                ['linear'],
                ['number', ['get', 'pm25']],
                0,  //Floor value of the scale
                34,  //Radius of floor value
                12,  //Ceiling value of the scale
                24  //Radius of Cieling Value
            ],
            'circle-color': [
                'interpolate',
                ['linear'],
                ['number', ['get', 'pm25']],
                0, '#00ff95',
                15, '#00c500',
                30, '#dbdf00',
                45, '#ffa600',
                60, '#ff3c00',
                110, '#a00000'
            ],
            'circle-opacity': 0.2
            },
            'filter': ['all', filterDate]
        });

        //NO2 layer
        map.addLayer({
            id: 'no2',
            type: 'circle',
            source: {
            type: 'geojson',
            data: 'https://raw.githubusercontent.com/neon-code/OSMtest/main/sthlm.geojson' // replace this with the url of your own geojson
            },
            paint: {
            'circle-radius': [
                'interpolate',
                ['linear'],
                ['number', ['get', 'no2']],
                0,  //Floor value of the scale
                34,  //Radius of floor value
                12,  //Ceiling value of the scale
                24  //Radius of Cieling Value
            ],
            'circle-color': [
                'interpolate',
                ['linear'],
                ['number', ['get', 'no2']],
                0, '#00ff95',
                50, '#00c500',
                100, '#dbdf00',
                200, '#ffa600',
                300, '#ff3c00',
                400, '#a00000'
            ],
            'circle-opacity': 0.4
            },
            'filter': ['all', filterDate]
        });
        
        //Filters to display current day information
        map.setFilter('pm10', ['==', ['string', ['get', 'date']], dateTimeArray[0]]);
        map.setFilter('pm25', ['==', ['string', ['get', 'date']], dateTimeArray[0]]);
        map.setFilter('no2', ['==', ['string', ['get', 'date']], dateTimeArray[0]]);

        // update Date filter when the slider is dragged
        document
        .getElementById('slider')
        .addEventListener('input', function (e) {
            var selecteddate = parseInt(e.target.value);
            // update the map
            filterDate = ['==', ['string', ['get', 'date']], dateTimeArray[arrLength -1 -selecteddate]];
            map.setFilter('pm10', ['all', filterDate]);
            map.setFilter('pm25', ['all', filterDate]);
            map.setFilter('no2', ['all', filterDate]);

            //Update slider date
            document.getElementById('active-date').innerText = dateTimeArray[arrLength -1 -selecteddate];
        });
        });
        });
    </script>
</html>