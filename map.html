<html>
   <head>
      <meta charset="utf-8">
      <title>Display a map on a webpage</title>
      <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
      <link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet">
      <script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
      <style>
         body { margin: 0; padding: 0; }
         #map { position: absolute; top: 0; bottom: 0; width: 100%; }
         #menu {
         position: absolute;
         background: #efefef;
         padding: 10px;
         font-family: 'Open Sans', sans-serif;
         bottom: 25px;
         }
         .marker {
            background-image: url('mapbox-icon.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
        }
        .mapboxgl-popup {
          max-width: 200px;
        }

        .mapboxgl-popup-content {
          text-align: center;
          font-family: 'Open Sans', sans-serif;
        }
      </style>
   </head>
   <body>
      <style>
         #menu {
         background: #fff;
         position: absolute;
         z-index: 1;
         right: 10px;
         border-radius: 3px;
         width: 120px;
         border: 1px solid rgba(0, 0, 0, 0.4);
         font-family: 'Open Sans', sans-serif;
         }
         #menu a {
         font-size: 13px;
         color: #404040;
         display: block;
         margin: 0;
         padding: 0;
         padding: 10px;
         text-decoration: none;
         border-bottom: 1px solid rgba(0, 0, 0, 0.25);
         text-align: center;
         }
         #menu a:last-child {
         border: none;
         }
         #menu a:hover {
         background-color: #f8f8f8;
         color: #404040;
         }
         #menu a.active {
         background-color: #3887be;
         color: #ffffff;
         }
         #menu a.active:hover {
         background: #3074a4;
         }
          h1 {
            font-size: 20px;
            line-height: 30px;
            }
            h2 {
            font-size: 14px;
            line-height: 20px;
            margin-bottom: 10px;
            }
            a {
            text-decoration: none;
            color: #2DC4B2;
            }
            #console {
            position: fixed;
            width: 240px;
            margin: 10px;
            padding: 10px 20px;
            background-color: white;
            bottom: 10px;
            }
            .session {
                margin-bottom: 20px;
            }
            .row {
                height: 12px;
                width: 100%;
            }
            .colors {
                background: linear-gradient(
                to right,
                #00FFBF,
                #00E700,
                #FFEE00,
                #FFC400,
                #FF3C00,
                #A00000
                );
                margin-bottom: 5px;
            }
            .label {
                width: 15%;
                display: inline-block;
                text-align: center;
            }

      </style>
      <nav id="menu"></nav>
      <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
      <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css">
      <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
      <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
      <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
      <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
      <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css">
      <div id="map"></div>
      <div id="console">
          <h1>Air Quality Data</h1>
          <p>
            Data:
            <a
              href="https://data.cityofnewyork.us/Public-Safety/NYPD-Motor-Vehicle-Collisions/h9gi-nx95"
              >PM10 values of air quality</a
            >
            in Stockholm, March 2021
          </p>
          <div class="session">
            <h2>PM10</h2>
            <div class="row colors"></div>
            <div class="row labels">
              <div class="label">0</div>
              <div class="label">10</div>
              <div class="label">20</div>
              <div class="label">40</div>
              <div class="label">60</div>
              <div class="label">80+</div>
            </div>
          </div>
          <div class='session' id='sliderbar'>
            <h2>Hour: <label id='active-date'>02/02/2021</label></h2>
            <input id='slider' class='row' type='range' min=0 max=55 step=1 value=0 />
          </div>
          </div>
      <script>
         // TO MAKE THE MAP APPEAR YOU MUST
         // ADD YOUR ACCESS TOKEN FROM
         // https://account.mapbox.com
         var apiKey = '93207702882a463c9fc8e53777fcf006'; // Your BreezoMeter API key
         mapboxgl.accessToken = 'pk.eyJ1Ijoic3lhbDEyMyIsImEiOiJja2xxZmp2ejMxY2xlMm5uM2EwbzN4N2RiIn0.fbgkVbfRijgPYmlPWYtPqg';
         var map = new mapboxgl.Map({
         container: 'map', // container id
         style: 'mapbox://styles/mapbox/streets-v11', // style URL
         center: [18.07030,59.32495], // starting position [lng, lat]
         zoom: 10// starting zoom
         
         });

        function fetchJSON(url) {
            return fetch(url)
                .then(function(response) {
                return response.json();
                });
            }
        var mapData;
        var uniqueDateTime = new Set();
        var dateTimeArray = [];
         
         map.addControl(
         new MapboxGeocoder({
         accessToken: mapboxgl.accessToken,
         mapboxgl: mapboxgl
         })
         );
         // map.addControl(new mapboxgl.NavigationControl());
         map.addControl(
         new MapboxDirections({
         accessToken: mapboxgl.accessToken
         }),
         'top-left'
         );
         /* map.on('load', function () {
            map.addSource('contours', {
            type: 'vector',
            url: 'mapbox://mapbox.mapbox-terrain-v2'
            });
            map.addLayer({
            'id': 'contours',
            'type': 'line',
            'source': 'contours',
            'source-layer': 'contour',
            'layout': {
            // make layer visible by default
            'visibility': 'visible',
            'line-join': 'round',
            'line-cap': 'round'
            },
            'paint': {
            'line-color': '#877b59',
            'line-width': 1
            }
            });
            map.addSource('traffic', {
            type: 'vector',
            url: 'mapbox://mapbox.mapbox-streets-v8'
            });
            map.addLayer({
            'id': 'admin',
            'type': 'admin',
            'source': 'traffic',
            'source-layer': 'admin',
            'layout': {
            // make layer visible by default
            'visibility': 'visible',
            'line-join': 'round',
            'line-cap': 'round'
            },
            'paint': {
            'line-color': '#ffffff',
            'line-width': 1
            }
            });
            map.addLayer({
            'id': 'building',
            'type': 'fill',
            'source': 'traffic',
            'source-layer': 'building',
            'layout': {
            // make layer visible by default
            'visibility': 'visible'
            },
            'paint': {
            'fill-color': 'rgba(66,100,251, 0.3)',
            'fill-outline-color': 'rgba(66,100,251, 1)'
            }
            });
         }); */
         
         /*  map.on('load', function () {
         map.addSource('wms-test-source', {
         'type': 'raster',
         // use the tiles option to specify a WMS tile source URL
         // https://docs.mapbox.com/mapbox-gl-js/style-spec/sources/
         'tiles': [
         'https://gis.slbanalys.se/geoserver/slb/wms?service=WMS&request=GetMap&layers=aqhi_d03&styles=&format=image%2Fpng&transparent=true&version=1.3.0&width=256&height=256&crs=EPSG%3A3011&bbox=6459374.999999156,149624.99999999994,6581249.999999152,151499.99999999997&tiled=true'
         ],
         'tileSize': 256
         });
         map.addLayer(
         {
         'id': 'wms-test-layer',
         'type': 'raster',
         'source': 'wms-test-source',
         'paint': {}
         },
         'aeroway-line'
         );
         }); */
         
         //breezometer
         function fetchJSON(url) {
            return fetch(url)
                .then(function(response) {
                return response.json();
                });
            }
        var mapData;
        var uniqueDateTime = new Set();
        var dateTimeArray = [];
        var pm10filterDate = ['==', ['string', ['get', 'date']], '00/00/00'];

         map.on("load", function() {
         addRasterSource();
         addRasterLayer();
         addRoadsSource();
         addRoadsLayer();
         addpm25Raster();
         addPm25Layer();
         
         addpm10Raster();
         addPm10Layer();
         addAqiSlbRaster();
         addAqiSlbLayer();
         var mapDataPromise = fetchJSON('https://raw.githubusercontent.com/neon-code/OSMtest/main/sthlm.geojson')
            .then(function(data) {
                mapData = data;
                data.features.forEach(function(feature) {
                uniqueDateTime.add(feature.properties.date);
            });
         dateTimeArray = [...uniqueDateTime]; 
         pm10filterDate = ['==', ['string', ['get', 'date']], dateTimeArray[0]];
         addHistoricalPm10Layer();

        // update Date filter when the slider is dragged
         map.setFilter('pm10Historical', ['==', ['string', ['get', 'date']], dateTimeArray[0]]);
            document
               .getElementById('slider')
               .addEventListener('input', function (e) {
            var selecteddate = parseInt(e.target.value);
            // update the map
            filterDate = ['==', ['string', ['get', 'date']], dateTimeArray[selecteddate]];
            map.setFilter('pm10Historical', ['all', filterDate]);
            //Update slider date
            document.getElementById('active-date').innerText = dateTimeArray[selecteddate];
        });

        });
         });
         
       // Create object that represents the locations where the measurements are taken
        var geojson = {
          type: 'FeatureCollection',
          features: [{
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [18.004651, 59.325755]
            },
            properties: {
              title: 'Lilla Essingen',
              description: 'PM10 value etc.'
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [18.05773847, 59.31691443]
            },
            properties: {
              title: 'S&ouml;dermalm',
              description: 'PM10 value etc.'
            }
          },
          {
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [18.07721584, 59.31464363]
            },
            properties: {
                title: 'Folkungagatan',
                description: 'PM10 value etc.'
            }
          },
          {
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [18.05827647, 59.34084657]
            },
            properties: {
                title: 'Sveav&auml;gen',
                description: 'PM10 value etc.'
            }
          },
          {
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [18.04906448, 59.31722043]
            },
            properties: {
                title: 'Hornsgatan',
                description: 'PM10 value etc.'
            }
          },
          {
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [18.03549986, 59.33716532]
            },
            properties: {
                title: 'St. Eriksgatan',
                description: 'PM10 value etc.'
            }
          }]
        };


         function addpm10Raster() {
         map.addSource('wmsPM10Source', {
         'type': 'raster',
         // use the tiles option to specify a WMS tile source URL
         // https://docs.mapbox.com/mapbox-gl-js/style-spec/sources/
         'tiles': [
         
         
         'https://gis.slbanalys.se/geoserver/slb/wms?service=WMS&request=GetMap&layers=pm10_d01&styles=&format=image%2Fpng&transparent=true&version=1.3.0&width=256&height=256&crs=EPSG%3A3857&bbox={bbox-epsg-3857}'
         ],
         'tileSize': 256
         });}
         
         function addAqiSlbRaster() {
         map.addSource('aqiSlbSource', {
         'type': 'raster',
         // use the tiles option to specify a WMS tile source URL
         // https://docs.mapbox.com/mapbox-gl-js/style-spec/sources/
         'tiles': [
         
         'https://gis.slbanalys.se/geoserver/slb/wms?service=WMS&request=GetMap&layers=aqhi_d01&styles=&format=image%2Fpng&transparent=true&version=1.3.0&width=256&height=256&crs=EPSG%3A3857&bbox={bbox-epsg-3857}'
         ],
         'tileSize': 256
         });
         }
         
         
         function addAqiSlbLayer() {
         map.addLayer(
         {
         'id': 'aqiSlbLayer',
         'type': 'raster',
         'source': 'aqiSlbSource',
      
         layout: {
          "visibility" : "none"
         },
         paint: {
           "raster-opacity": 0.6
         }
         
         }
         //'aeroway-line'
         );
         }     
         
         
         function addPm10Layer() {
         map.addLayer(
         {
         'id': 'wmsPM10Layer',
         'type': 'raster',
         'source': 'wmsPM10Source',
       
         layout: {
          "visibility" : "none"
         },
         paint: {
           "raster-opacity": 0.6
         }
         
         }
         //'aeroway-line'
         );
         }
         
         function addRoadsSource() {
            map.addSource("roads", {
            type: "vector",
            tiles: [
         `https://tiles.breezometer.com/v1/air-quality/traffic-pollution/current-conditions/{z}/{x}/{y}.pbf?key=${apiKey}`
         ],
         minzoom: 0,
         maxzoom: 10
         });
         }
         
         function addRoadsLayer() {
         map.addLayer(
         {
         id: "traffic",
         source: "roads",
         "source-layer": "brz-roads",
         type: "line",
         layout: {
           "line-cap": "round",
           "visibility": "none"
         },
         minzoom: 3,
         maxzoom: 24
         },
         "admin-1-boundary-bg"
         );
         }
         function addpm25Raster() {
         map.addSource("breezometer-tiles-pm25", {
         type: "raster",
         tiles: [`https://tiles.breezometer.com/v1/air-quality/pm25/current-conditions/{z}/{x}/{y}.png?key=${apiKey}`],
         tileSize: 256,
         maxzoom: 8
         });
         }
         
         function addPm25Layer() {
         map.addLayer(
         {
         id: "pm25",
         type: "raster",
         source: "breezometer-tiles-pm25",
         minzoom: 0,
         maxzoom: 22,
         layout: {
            "visibility" : "none"
         },
         paint: {
           "raster-opacity": 0.6
         }
         },
         "admin-1-boundary-bg"
         );
         }
         
         function addPollenSource() {
         map.addSource("breezometer-tiles-pollen", {
         type: "raster",
         tiles: [`https://tiles.breezometer.com/v1/pollen/grass/forecast/daily/{z}/{x}/{y}.png?key=${apiKey}`],
         tileSize: 256,
         maxzoom: 8
         });
         }
         
         function addPollenLayer() {
         map.addLayer(
         {
         id: "pollen",
         type: "raster",
         source: "breezometer-tiles-pollen",
         minzoom: 0,
         maxzoom: 22,
         paint: {
           "raster-opacity": 0.6
         },
           layout: {
            "visibility" : "none"
         },
         
         },
         "admin-1-boundary-bg"
         );
         }

         function addHistoricalPm10Layer() {
                    map.addLayer({
            id: 'pm10Historical',
            type: 'circle',
            source: {
            type: 'geojson',
            data: 'https://raw.githubusercontent.com/neon-code/OSMtest/main/sthlm.geojson' // replace this with the url of your own geojson
            },
            layout: {
               'visibility' : 'none'
            },
            paint: {
            'circle-radius': [
                'interpolate',
                ['linear'],
                ['number', ['get', 'pm10']],
                0,  //Floor value of the scale
                34,  //Radius of floor value
                12,  //Ceiling value of the scale
                24  //Radius of Cieling Value
            ],
            'circle-color': [
                'interpolate',
                ['linear'],
                ['number', ['get', 'pm10']],
                0, '#00FF95',
                10, '#00C500',
                20, '#DBDF00',
                40, '#FFA600',
                60, '#FF3C00',
                80, '#A00000'
            ],
            'circle-opacity': 0.4
            },
            'filter': ['all', pm10filterDate]
        });
         }
         
         // enumerate ids of the layers
         var toggleableLayerIds = ['aqi', 'pm25', 'traffic','aqiSlbLayer','wmsPM10Layer'];
         
         // set up the corresponding toggle button for each layer
         for (var i = 0; i < toggleableLayerIds.length; i++) {
         var id = toggleableLayerIds[i];
         
         var link = document.createElement('a');
         link.href = '#';
         link.className = '';
         link.textContent = id.toUpperCase();
         if(id == 'aqi') {
            link.className = 'active'
         }
         link.title = id;
         
         link.onclick = function (e) {
         //var clickedLayer = this.textContent.toLowerCase();
         var clickedLayer = this.title;
         e.preventDefault();
         e.stopPropagation();
         
         var visibility = map.getLayoutProperty(clickedLayer, 'visibility');
         
         // toggle layer visibility by changing the layout object's visibility property
         if (visibility === 'visible') {
         map.setLayoutProperty(clickedLayer, 'visibility', 'none');
         this.className = '';
         } else {
         this.className = 'active';
         map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
         }
         };
         
         
         var layers = document.getElementById('menu');
         layers.appendChild(link);
         }
         
         var link = document.createElement('a');
         link.href = '#';
         link.className = '';
         link.textContent = 'VIEW HISTORY';
         link.title = 'viewHistory';
         
         link.onclick = function (e) {
         //var clickedLayer = this.textContent.toLowerCase();
         var clickedLayer = 'pm10Historical'
         e.preventDefault();
         e.stopPropagation();
         
         var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

         for (var i = 0; i < toggleableLayerIds.length; i++) {
         var id = toggleableLayerIds[i];
         var visibility = map.getLayoutProperty(id, 'visibility');
         map.setLayoutProperty(id, 'visibility', 'none');
         this.className = '';

            }
         
         // toggle layer visibility by changing the layout object's visibility property
         if (visibility === 'visible') {
         map.setLayoutProperty(clickedLayer, 'visibility', 'none');
         this.className = '';
         } else {
         this.className = 'active';
         map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
         }
         };

         var layers = document.getElementById('menu');
         layers.appendChild(link);

         
         function addRasterSource() {
         map.addSource("breezometer-tiles", {
         type: "raster",
         tiles: [
         `https://tiles.breezometer.com/v1/air-quality/breezometer-aqi/current-conditions/{z}/{x}/{y}.png?key=${apiKey}`//
         ],
         tileSize: 256,
         maxzoom: 8
         });
         }
         
         function addRasterLayer() {
         map.addLayer(
         {
         id: "aqi",
         type: "raster",
         source: "breezometer-tiles",
         minzoom: 0,
         maxzoom: 22,
         'layout': {
         // make layer visible by default
         'visibility': 'visible'
         },
         paint: {
           "raster-opacity": 0.6
         }
         },
         "admin-1-boundary-bg"
         );
         }
         
        // Add measurement location markers to map
        geojson.features.forEach(function(marker) {

          // create a HTML element for each feature
          var el = document.createElement('div');
          el.className = 'marker';

          //console.log("marker created");
          // make a marker for each feature and add to the map
          new mapboxgl.Marker(el)
            .setLngLat(marker.geometry.coordinates)
            .addTo(map);


           new mapboxgl.Marker(el)
          .setLngLat(marker.geometry.coordinates)
          .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
          .setHTML('<h3>' + marker.properties.title + '</h3><p>' + marker.properties.description + '</p>'))
          .addTo(map);


        });
      </script>
   </body>
</html>
